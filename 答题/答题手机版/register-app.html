<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%
    String path = request.getContextPath();
%>
<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

		<title>2019年全国节约用水 知识大赛</title>
		<link rel="stylesheet" href="<c:url value='/js/layui/css/layui.css'/>" />
		<!-- <script src="images/jquery-1.9.1.js" type="text/javascript" charset="utf-8"></script> -->
		<script src="<c:url value='/js/jquery/jquery.min.js'/>"></script>
		<script src="<c:url value='/js/layui/layui.js'/>"></script>
		<script src="<c:url value='/js/base64/base64.js'/>"></script>
		<script src="<c:url value='/js/jQueryDistpicker/dist/distpicker.data.min.js'/>"></script>
		<script src="<c:url value='/js/jQueryDistpicker/dist/distpicker.min.js'/>"></script>
		<script src="<c:url value='/js/IDCardValidator.js'/>"></script>
		<!-- Bootstrap core CSS -->
		<link href="images/bootstrap.css" rel="stylesheet">
		
		<script src="images/bootstrap.js" type="text/javascript" charset="utf-8"></script>
		<link rel="stylesheet" type="text/css" href="images/20190916-mystyle-app.css" />
		<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
		<!--[if lt IE 9]>
	      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
	      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    	<![endif]-->
		<style type="text/css">
			select {
				border: 1px solid #00B7EE;
				width: 98%;
			}
			
			.register-content {
				margin-bottom: 50px;
			}
		</style>
	</head>

	<body>
		<div class="container-fluid banner">
			<img src="images/20190916-register-app.png" />
		</div>
		<div class="container-fluid register-content">
			<form class="layui-form reg-font">

				<ul class="login-app">
					<li class="row">
						<div class="qianzui col-xs-4">姓　　名：</div>
						<div class="houzhui col-xs-8"><input id="userName" type="text" class="layui-input" lay-verify="required|username" autocomplete="off" required /></div>
					</li>
					<li class="row">
						<div class="qianzui col-xs-4">单　　位：</div>
						<div class="houzhui col-xs-8">
							<div class="layui-input-inline" style="width: 50%;float: left;">
								<select id="p_dept" class="middle" lay-filter="dept_filter" lay-search>
									<option value="">请选择</option>
								</select>
							</div>
							<div class="layui-input-inline" style="width: 50%; float: left;">
								<select id="c_dept" class="middle" lay-search>
									<option value="">请选择</option>
								</select>
							</div>
						</div>
					</li>
					<li class="row">
						<div class="qianzui col-xs-4">单位名称：</div>
						<div class="houzhui col-xs-8">
							<input id="deptName" type="text" class="layui-input" autocomplete="off" />
						</div>
					</li>
					<li class="row">
						<div class="qianzui col-xs-4">身份证号：</div>
						<div class="houzhui col-xs-8">
							<input id="idCard" type="text" class="layui-input" lay-verify="required|idCard" autocomplete="off" required/>
						</div>
					</li>
					<li class="row">
						<div class="qianzui col-xs-4">手机号码：</div>
						<div class="houzhui col-xs-8">
							<input id="telphone" type="text" class="layui-input" lay-verify="required|phone" required/>
						</div>
					</li>
					<li class="row">
						<div class="qianzui col-xs-4">所在地区：</div>
						<div class="houzhui col-xs-8">
							<div data-toggle="distpicker">
								<div class="layui-input-inline" style="width: 50%;float: left;">
									<select lay-filter="p" id="province" lay-verify="required"></select>
								</div>
								<div class="layui-input-inline" style="width: 50%;float: left;">
									<select lay-filter="c" id="city" lay-verify="required"></select>
								</div>
							</div>
						</div>
					</li>
					<li class="row">
						<div class="qianzui col-xs-4">职　　业：</div>
						<div class="houzhui col-xs-8">
							<div class="layui-input-inline" style="width: 100%">
								<select id="profession" lay-verify="required">
									<option value=""></option>
									<option value="1">行政事业</option>
									<option value="2">企业商业</option>
									<option value="3">学生</option>
									<option value="4">军人</option>
									<option value="5">农民</option>
									<option value="6">水利</option>
									<option value="7">其他</option>
								</select>
							</div>
						</div>
					</li>
					<li class="row">
						<div class="qianzui col-xs-4">学　　历：</div>
						<div class="houzhui col-xs-8">
							<div class="layui-input-inline" style="width:100%">
								<select id="educational" lay-verify="required">
									<option value=""></option>
									<option value="1">小学</option>
									<option value="2">中学</option>
									<option value="3">大学及以上</option>
								</select>
							</div>
						</div>
					</li>
					<li class="row">
						<div class="qianzui col-xs-4 col-md-4">验&nbsp;证&nbsp;码：</div>
						<div class="houzhui col-xs-8 col-md-8"><input id="auth_code" type="text" style="width: 65%;" class="layui-input" autocomplete="off" />
							<img id="authCode" src="<%=path %>/getAuthCode" width="30%" height="29" class="middle" onclick="changeAuthCode();" style="cursor: pointer;" /></div>
					</li>
				</ul>

				<div class="hei2-btn text-center">
					<button class="button" lay-submit lay-filter="submit" style="border:none;">提交</button>
					<!-- <button type="reset" class=" layui-btn-primary button" style="border:none;">重置</button> -->
				</div>
			</form>
		</div>

	<script>
    layui.use('form', function () {
        var form = layui.form;
        /*-------------------- 单位选项 ------------------*/
        var _dept;
        $.getJSON("<%=path%>/js/dept.json", function (data) {
            _dept = data;
            $.each(_dept.dept, function (i, v) {
                $("#p_dept").append(new Option(v.name, v.pid));
            });
            form.render('select');
        });

        form.on('select(dept_filter)', function (data) {
            var p_dept_id = data.value;
            if (_dept) {
                if (p_dept_id < 5) {
                    $.each(_dept.dept, function (i, v) {
                        if (v.pid == p_dept_id) {
                            $("#c_dept").empty();
                            $.each(v.child, function (index, val) {
                                $("#c_dept").append(new Option(val.name, val.cid));
                            });
                        }
                    });
                } else {
                    $("#c_dept").empty();
                }
                form.render("select");
            }
        });
        /*-------------------- 单位选项 ------------------*/

        //自定义验证规则
        form.verify({
            username: function (value) {
                if (!new RegExp("^[a-zA-Z0-9_\u4e00-\u9fa5\\s·]+$").test(value)) {
                    return '用户名不能有特殊字符';
                }
                if (/(^\_)|(\__)|(\_+$)/.test(value)) {
                    return '用户名首尾不能出现下划线\'_\'';
                }
                if (/^\d+\d+\d$/.test(value)) {
                    return '用户名不能全为数字';
                }
                /*var msg;
                $.ajax({
                    type: "POST",
                    url: "<%=path%>/isExists",
                    data: {userName: value},
                    dataType: "json",
                    async: false,
                    success: function (json) {
                        if (json.code === 0)
                            msg = json.code;
                    }
                });
                if (msg === 0) {
                    return "用户名已存在！";
                }*/
            },
            idCard: function (value) {
                /*if (!new RegExp("^[a-zA-Z0-9_\u4e00-\u9fa5\\s·]+$").test(value)) {
                    return '用户名不能有特殊字符';
                }
                if (/(^\_)|(\__)|(\_+$)/.test(value)) {
                    return '用户名首尾不能出现下划线\'_\'';
                }
                if (/^\d+\d+\d$/.test(value)) {
                    return '用户名不能全为数字';
                }*/
                var base64 = new Base64();
                var errorMsg = isChinaIDCard(value, errorMsg);
                if (errorMsg) {
                    return errorMsg;
                }
                var msg;
                $.ajax({
                    type: "POST",
                    url: "<%=path%>/isExistsByIdCard",
                    data: {idCard: base64.encode(value)},
                    dataType: "json",
                    async: false,
                    success: function (json) {
                        if (json.code === 0) {
                            msg = json.code;
                        }
                    }
                });
                if (msg === 0) {
                    return "身份证号已存在！";
                }
            },
            phone: function (value) {
                if (value) {
                    /*if (!(/^1(3|4|5|7|8)\d{9}$/.test(value))) {
                        return "请输入正确的手机号";
                    }*/
                    var isPhone = /^([0-9]{3,4}-)?[0-9]{7,8}$/;
                     var isMob = /^[1](([3][0-9])|([4][5-9])|([5][0-3,5-9])|([6][5,6])|([7][0-8])|([8][0-9])|([9][1,8,9]))[0-9]{8}$/;
                    if (!(isMob.test(value) || isPhone.test(value))) {
                        return "请输入正确的手机号";
                    }
                }
            }
        });

        //事件监听

        form.on('select(p)', function (data) {
            $("#province").val(data.value).change();
            form.render();
        });
        form.on('select(c)', function (data) {
            $("#city").val(data.value).change();
            form.render();
        });

        //监听提交
        form.on('submit(submit)', function (data) {
            console.log(data);
            doRegister();

            return false;
        });
    });

    function changeAuthCode() {
        $("#authCode").attr("src", "<%=path %>/getAuthCode?d=" + new Date().getTime());
    }
    ;
    function doRegister() {
        var base64 = new Base64();
        var data = {
            "userName": $("#userName").val(),
            "idCard": base64.encode($("#idCard").val()),
            "telphone": $("#telphone").val(),
            "province": $("#province option:selected").data("code"),
            "city": $("#city option:selected").data("code"),
            "profession": $("#profession").val(),
            "educational": $("#educational").val(),
            "parentId": $("#p_dept").val(),
            "deptId": $("#c_dept").val(),
            "deptName": $("#deptName").val(),
            "authCode": $("#code").val()
        };

        if ($("#address").val()) {
            data.address = $("#address").val();
        }
        if ($("#postCode").val()) {
            data.postCode = $("#postCode").val();
        }
        $.ajax({
            type: "POST",
            url: "<%=path%>/doRegister",
            data: data,
            dataType: "json",
            async: false,
            success: function (json) {
                if (!json.code) {
                    layer.alert("注册成功！", {
                        icon: 1,
                        skin: "layui-layer-lan",
                        closeBtn: 0,
                        title: "提示信息"
                    }, function () {
                        window.location.href = "<%=path%>/templates/jieyueyongshui/answer.jsp";
                    });
                } else {
                    layer_alert(json.message);
                }
            }
        });
    }
</script>
<!-- PHPStat Start -->
<script language="JavaScript" charset="utf-8" src="//pv.mwr.gov.cn/count/10000073/10000073.js" ignoreapd="1" ></script>
<!-- /PHPStat End -->
	</body>

</html>